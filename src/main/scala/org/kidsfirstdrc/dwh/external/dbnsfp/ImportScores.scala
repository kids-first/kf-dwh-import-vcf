package org.kidsfirstdrc.dwh.external.dbnsfp

import org.apache.spark.sql.functions._
import org.apache.spark.sql.SparkSession

object ImportScores extends App {

  implicit val spark: SparkSession = SparkSession.builder
    .config("hive.metastore.client.factory.class", "com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory")
    .enableHiveSupport()
    .appName("Import DBSNFP Scores to DWH").getOrCreate()

  import spark.implicits._

  import org.apache.spark.sql.Column
  import org.apache.spark.sql.types.DoubleType

  def split_semicolon(colName: String, outputColName: String): Column = split(col(colName), ";") as outputColName

  def split_semicolon(colName: String): Column = split_semicolon(colName, colName)

  def element_at_postion(colName: String) = element_at(col(colName), col("position")) as colName

  def score(colName: String) = when(element_at_postion(colName) === ".", null).otherwise(element_at_postion(colName).cast(DoubleType)) as colName
  def cast(colName: String) = col(colName).cast(DoubleType) as colName

  def pred(colName: String) = when(element_at_postion(colName) === ".", null).otherwise(element_at_postion(colName)) as colName


  spark.table("variant.dbnsfp").select(
    $"chromosome",
    $"start",
    $"reference",
    $"alternate",
    split_semicolon("aapos"),
    split_semicolon("refcodon"),
    split_semicolon("codonpos"),
    $"aaref",
    split_semicolon("Ensembl_proteinid", "ensembl_protein_id"),
    split_semicolon("genename", "symbol"),
    split_semicolon("Ensembl_geneid", "ensembl_gene_id"),
    split_semicolon("VEP_canonical"),
    posexplode(split($"Ensembl_transcriptid", ";")),
    split_semicolon("cds_strand"),
    split_semicolon("SIFT_score"),
    split_semicolon("SIFT_pred"),
    $"SIFT_converted_rankscore",
    split_semicolon("Polyphen2_HDIV_score"),
    split_semicolon("Polyphen2_HDIV_pred"),
    $"Polyphen2_HDIV_rankscore",
    split_semicolon("Polyphen2_HVAR_score"),
    split_semicolon("Polyphen2_HVAR_pred"),
    $"Polyphen2_HVAR_rankscore",
    split_semicolon("FATHMM_score"),
    split_semicolon("FATHMM_pred"),
    $"FATHMM_converted_rankscore",
    $"REVEL_rankscore",
    $"LRT_converted_rankscore",
    $"LRT_pred",
    $"CADD_raw",
    $"CADD_raw_rankscore",
    $"CADD_phred",
    $"DANN_score",
    $"DANN_rankscore",
    $"phyloP100way_vertebrate",
    $"phyloP100way_vertebrate_rankscore",
    $"phyloP30way_mammalian",
    $"phyloP30way_mammalian_rankscore",
    $"phyloP17way_primate",
    $"phyloP17way_primate_rankscore",
    $"phastCons100way_vertebrate",
    $"phastCons100way_vertebrate_rankscore",
    $"phastCons30way_mammalian",
    $"phastCons30way_mammalian_rankscore",
    $"phastCons17way_primate",
    $"phastCons17way_primate_rankscore",
    $"GERP++_NR",
    $"GERP++_RS",
    $"GERP++_RS_rankscore",

    $"MutPred_rankscore",
    $"MutPred_score",

    split_semicolon("MutationAssessor_pred"),
    split_semicolon("MutationAssessor_score"),
    $"MutationAssessor_rankscore",
    $"MutationTaster_converted_rankscore",

    split_semicolon("PROVEAN_pred"),
    split_semicolon("PROVEAN_score"),
    $"PROVEAN_converted_rankscore",
    split_semicolon("VEST4_score"),
    $"VEST4_rankscore",
    $"MetaSVM_pred",
    $"MetaSVM_rankscore",
    $"MetaSVM_score",
    $"MetaLR_pred",
    $"MetaLR_rankscore",
    $"MetaLR_score",

    $"M-CAP_pred",
    $"M-CAP_rankscore",
    $"M-CAP_score",
    split_semicolon("MPC_score"),
    $"MPC_rankscore",
    split_semicolon("MVP_score"),
    $"MVP_rankscore",
    $"PrimateAI_pred",
    $"PrimateAI_rankscore",
    $"PrimateAI_score",
    split_semicolon("DEOGEN2_pred"),
    split_semicolon("DEOGEN2_score"),
    $"DEOGEN2_rankscore",
    $"BayesDel_addAF_pred",
    $"BayesDel_addAF_rankscore",
    $"BayesDel_addAF_score",
    $"BayesDel_noAF_pred",
    $"BayesDel_noAF_rankscore",
    $"BayesDel_noAF_score",
    $"ClinPred_pred",
    $"ClinPred_rankscore",
    $"ClinPred_score",
    split_semicolon("LIST-S2_pred"),
    split_semicolon("LIST-S2_score"),
    $"LIST-S2_rankscore",
    $"fathmm-MKL_coding_pred",
    $"fathmm-MKL_coding_rankscore",
    $"fathmm-MKL_coding_score",
    $"fathmm-MKL_coding_group",
    $"fathmm-XF_coding_pred",
    $"fathmm-XF_coding_rankscore",
    $"fathmm-XF_coding_score",
    $"Eigen-PC-phred_coding",
    $"Eigen-PC-raw_coding",
    $"Eigen-PC-raw_coding_rankscore",
    $"Eigen-phred_coding",
    $"Eigen-raw_coding",
    $"Eigen-raw_coding_rankscore",
    $"GenoCanyon_rankscore",
    $"GenoCanyon_score",
    $"integrated_confidence_value",
    $"integrated_fitCons_rankscore",
    $"integrated_fitCons_score",
    $"GM12878_confidence_value",
    $"GM12878_fitCons_rankscore",
    $"GM12878_fitCons_score",
    $"H1-hESC_confidence_value",
    $"H1-hESC_fitCons_rankscore",
    $"H1-hESC_fitCons_score",
    $"HUVEC_confidence_value",
    $"HUVEC_fitCons_rankscore",
    $"HUVEC_fitCons_score",
    $"LINSIGHT",
    $"LINSIGHT_rankscore",
    $"bStatistic",
    $"bStatistic_converted_rankscore",
    split_semicolon("Interpro_domain"),
    split_semicolon("GTEx_V8_gene"),
    split_semicolon("GTEx_V8_tissue")
  )
    .withColumnRenamed("col", "ensembl_transcript_id")
    .withColumn("position", $"pos" + 1)
    .drop("pos")
    .select(
      $"chromosome",
      $"start",
      $"reference",
      $"alternate",
      $"aaref",
      element_at_postion("symbol"),
      element_at_postion("ensembl_gene_id"),
      element_at_postion("ensembl_protein_id"),
      element_at_postion("VEP_canonical"),
      $"ensembl_transcript_id",
      element_at_postion("cds_strand"),
      score("SIFT_score"),
      pred("SIFT_pred"),
      cast("SIFT_converted_rankscore"),

      score("Polyphen2_HDIV_score"),
      pred("Polyphen2_HDIV_pred"),
      cast("Polyphen2_HDIV_rankscore"),

      score("Polyphen2_HVAR_score"),
      pred("Polyphen2_HVAR_pred"),
      cast("Polyphen2_HVAR_rankscore"),

      score("FATHMM_score"),
      pred("FATHMM_pred"),
      cast("FATHMM_converted_rankscore"),

      cast("CADD_raw"),
      cast("CADD_raw_rankscore"),
      cast("CADD_phred"),
      cast("DANN_score"),
      cast("DANN_rankscore"),

      cast("REVEL_rankscore"),
      cast("LRT_converted_rankscore"),
      $"LRT_pred",
      cast("phyloP100way_vertebrate"),
      cast("phyloP100way_vertebrate_rankscore"),
      cast("phyloP30way_mammalian"),
      cast("phyloP30way_mammalian_rankscore"),
      cast("phyloP17way_primate"),
      cast("phyloP17way_primate_rankscore"),
      cast("phastCons100way_vertebrate"),
      cast("phastCons100way_vertebrate_rankscore"),
      cast("phastcons30way_mammalian"),
      cast("phastCons30way_mammalian_rankscore"),
      cast("phastCons17way_primate"),
      cast("phastCons17way_primate_rankscore"),
      cast("GERP++_NR"),
      cast("GERP++_RS"),
      cast("GERP++_RS_rankscore"),
      cast("MutPred_rankscore"),
      cast("MutPred_score"),
      pred("MutationAssessor_pred"),
      score("MutationAssessor_score"),
      cast("MutationAssessor_rankscore"),
      cast("MutationTaster_converted_rankscore"),
      pred("PROVEAN_pred"),
      score("PROVEAN_score"),
      cast("PROVEAN_converted_rankscore"),
      score("VEST4_score"),
      cast("VEST4_rankscore"),
      $"MetaSVM_pred",
      cast("MetaSVM_rankscore"),
      cast("MetaSVM_score"),
      col("MetaLR_pred"),
      cast("MetaLR_rankscore"),
      cast("MetaLR_score"),
      col("M-CAP_pred"),
      cast("M-CAP_score"),
      cast("M-CAP_rankscore"),
      score("MPC_score"),
      cast("MPC_rankscore"),
      score("MVP_score"),
      cast("MVP_rankscore"),
      col("PrimateAI_pred"),
      cast("PrimateAI_rankscore"),
      cast("PrimateAI_score"),
      pred("DEOGEN2_pred"),
      score("DEOGEN2_score"),
      cast("DEOGEN2_rankscore"),
      col("BayesDel_addAF_pred"),
      cast("BayesDel_addAF_rankscore"),
      cast("BayesDel_addAF_score"),
      col("BayesDel_noAF_pred"),
      cast("BayesDel_noAF_rankscore"),
      cast("BayesDel_noAF_score"),
      col("ClinPred_pred"),
      cast("ClinPred_rankscore"),
      cast("ClinPred_score"),
      pred("LIST-S2_pred"),
      score("LIST-S2_score"),
      cast("LIST-S2_rankscore"),
      $"fathmm-MKL_coding_pred",
      cast("fathmm-MKL_coding_rankscore"),
      cast("fathmm-MKL_coding_score"),
      $"fathmm-MKL_coding_group",
      $"fathmm-XF_coding_pred",
      cast("fathmm-XF_coding_rankscore"),
      cast("fathmm-XF_coding_score"),
      cast("Eigen-PC-phred_coding"),
      cast("Eigen-PC-raw_coding"),
      cast("Eigen-PC-raw_coding_rankscore"),
      cast("Eigen-phred_coding"),
      cast("Eigen-raw_coding"),
      cast("Eigen-raw_coding_rankscore"),
      cast("GenoCanyon_rankscore"),
      cast("GenoCanyon_score"),
      cast("integrated_confidence_value"),
      cast("integrated_fitCons_rankscore"),
      cast("integrated_fitCons_score"),
      cast("GM12878_confidence_value"),
      cast("GM12878_fitCons_rankscore"),
      cast("GM12878_fitCons_score"),
      cast("H1-hESC_confidence_value"),
      cast("H1-hESC_fitCons_rankscore"),
      cast("H1-hESC_fitCons_score"),
      cast("HUVEC_confidence_value"),
      cast("HUVEC_fitCons_rankscore"),
      cast("HUVEC_fitCons_score"),
      cast("LINSIGHT"),
      cast("LINSIGHT_rankscore"),
      cast("bStatistic"),
      cast("bStatistic_converted_rankscore"),
      element_at_postion("Interpro_domain"),
      $"GTEx_V8_gene",
      $"GTEx_V8_tissue"
    )
    .drop("position")
    .repartition($"chromosome")
    .sortWithinPartitions("start")
    .write.mode("overwrite")
    .partitionBy("chromosome")
    .format("parquet")
    .option("path", "s3a://kf-strides-variant-parquet-prd/public/dbnsfp/scores")
    .saveAsTable("variant.dbnsfp_original")


}

